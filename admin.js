// Initialize Web3
const web3 = new Web3(Web3.givenProvider || "http://localhost:7545");

// Contract Address and ABI
const contractAddress = "0x2119EC0C931677cD2a2748107f22C61faCaBf4C3"; // Replace with your deployed contract address
const abi = [
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "ownerName",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "location",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "area",
        "type": "uint256"
      }
    ],
    "name": "LandAdded",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      }
    ],
    "name": "LandApproved",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "newOwner",
        "type": "string"
      }
    ],
    "name": "LandTransferred",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "address",
        "name": "user",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "name",
        "type": "string"
      }
    ],
    "name": "UserRegistered",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "admin",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "isAdmin",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "landCount",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "lands",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "ownerName",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "location",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "area",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "isSold",
        "type": "bool"
      },
      {
        "internalType": "bool",
        "name": "isApproved",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "userDetails",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_newAdmin",
        "type": "address"
      }
    ],
    "name": "addAdmin",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      }
    ],
    "name": "registerUser",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_ownerName",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_location",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "_area",
        "type": "uint256"
      }
    ],
    "name": "addLand",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      }
    ],
    "name": "approveLand",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "_newOwner",
        "type": "string"
      }
    ],
    "name": "transferLand",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      }
    ],
    "name": "getLand",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      },
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];
let contract;

async function init() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.enable();
        contract = new web3.eth.Contract(abi, contractAddress);
        loadPendingLands();
        loadPendingTransfers();
        loadDisputes();
    } else {
        alert("Please install MetaMask!");
    }
}

async function loadPendingLands() {
    let pendingLands = document.getElementById("pendingLands");
    pendingLands.innerHTML = "";

    let count = await contract.methods.landCount().call();
    for (let i = 1; i <= count; i++) {
        let land = await contract.methods.lands(i).call();
        if (!land.isApproved) {
            pendingLands.innerHTML += `
                <div class="bg-white p-4 shadow-md">
                    <p><strong>Owner:</strong> ${land.ownerName}</p>
                    <p><strong>Location:</strong> ${land.location}</p>
                    <button onclick="approveLand(${i})" class="bg-green-500 text-white px-4 py-2 mt-2">Approve</button>
                </div>`;
        }
    }
}

async function approveLand(id) {
    let accounts = await web3.eth.getAccounts();
    await contract.methods.approveLand(id).send({ from: accounts[0] });
    Swal.fire("Success!", "Land approved successfully", "success");
    loadPendingLands();
}

async function loadPendingTransfers() {
    let transfersDiv = document.getElementById("pendingTransfers");
    transfersDiv.innerHTML = "";

    let count = await contract.methods.landCount().call();
    for (let i = 1; i <= count; i++) {
        let transfer = await contract.methods.pendingTransfers(i).call();
        if (!transfer.isApproved) {
            transfersDiv.innerHTML += `
                <div class="bg-white p-4 shadow-md">
                    <p><strong>Land ID:</strong> ${i}</p>
                    <p><strong>New Owner:</strong> ${transfer.newOwner}</p>
                    <button onclick="approveTransfer(${i})" class="bg-blue-500 text-white px-4 py-2">Approve Transfer</button>
                </div>`;
        }
    }
}

async function approveTransfer(id) {
    let accounts = await web3.eth.getAccounts();
    await contract.methods.approveTransfer(id).send({ from: accounts[0] });
    Swal.fire("Success!", "Transfer approved successfully", "success");
    loadPendingTransfers();
}

window.onload = init;